@page "/equip"
@using Blazorise.DataGrid
@using TKZ.Shared.Model
@inject HttpClient Http
@inject Toolbelt.Blazor.I18nText.I18nText I18nText
@inject LogBase Log
@inject Grid grid

@if (equipment == null)
{
    <LoadingElement />
}
else
{
    <div class="w3-animate-opacity">
        <DataGrid TItem="Equip"
                  Data="@equipment"
                  PageSize="@equipment.Count"
                  EditMode="@DataGridEditMode.Inline"
                  Editable="true"
                  Sortable="true"
                  Filterable="true"
                  RowInserted="@OnRowInserted"
                  RowUpdated="@OnRowUpdated"
                  RowRemoved="@OnRowRemoved"
                  Narrow="true"
                  HeaderRowClass="small"
                  Class="my_table text-center">
            @*IsActive*@
            <DataGridColumn TItem="Equip"
                            Field="@nameof(Equip.IsActive)"
                            Caption="@(@Localizer.IsActive)"
                            Editable="true"
                            Sortable="true">
                <DisplayTemplate>
                    <Check TValue="bool" Checked="context.IsActive" CheckedChanged="@((v)=>context.IsActive = v)" />
                </DisplayTemplate>
                <EditTemplate>
                    <Check TValue="bool" Checked="@((bool)( ( (CellEditContext)context ).CellValue ))" CheckedChanged="@(( v ) => ( (CellEditContext)context ).CellValue = v)" />
                </EditTemplate>
                <FilterTemplate>
                    <Select TValue="string" SelectedValueChanged="@(e => context.TriggerFilterChange(e == "*" ? "" : e.ToString()))">
                        <SelectItem Value="@("*")"></SelectItem>
                        <SelectItem Value="@(true.ToString())">@Localizer.ActiveFilter</SelectItem>
                        <SelectItem Value="@(false.ToString())">@Localizer.NotActiveFilter</SelectItem>
                    </Select>
                </FilterTemplate>
            </DataGridColumn>
            @*BusId*@
            <DataGridNumericColumn TItem="Equip"
                                   Field="@nameof(Equip.BusId)"
                                   Caption="@Localizer.Bus"
                                   Editable="true"
                                   Sortable="true"
                                   Filterable="true">
                <DisplayTemplate>
                    @if (grid.Buses.ContainsKey(context.BusId))@grid.Buses[context.BusId].Name
                </DisplayTemplate>
                <EditTemplate>
                    <Select TValue="int" SelectedValue="@((int)(((CellEditContext)context).CellValue))" SelectedValueChanged="@((v) => ((CellEditContext)context).CellValue = v)">
                        <SelectItem Value="@("*")"></SelectItem>
                        @foreach (var item in grid.Buses.Values.Where(b => b.Id != 0).OrderBy(b => b.Name))
                        {
                        <SelectItem TValue="int" Value="@(item.Id)">@item.Name</SelectItem>
                        }
                    </Select>
                </EditTemplate>
                <FilterTemplate>
                    <Select TValue="string" SelectedValueChanged="@(e => context.TriggerFilterChange(e == "*" ? "" : e.ToString()))">
                        <SelectItem Value="@("*")"></SelectItem>
                        @foreach (var item in equipment.Select(b => b.BusId).Distinct().OrderBy(n => n))
                        {
                            if (grid.Buses.ContainsKey(item))
                            {
                        <SelectItem Value="@item">@grid.Buses[item].Name</SelectItem>
                            }
                        }
                    </Select>
                </FilterTemplate>
            </DataGridNumericColumn>

            @*Name*@
            <DataGridColumn TItem="Equip"
                            Field="@nameof(Equip.Name)"
                            Caption="@(@Localizer.Name)"
                            Editable="true"
                            Sortable="true">
            </DataGridColumn>
            @*R*@
            <DataGridNumericColumn TItem="Equip"
                                   Field="@nameof(Equip.R)"
                                   Caption="@(new String("R, ["+@Localizer.ohm+"]"))"
                                   Editable="true"
                                   Sortable="true"></DataGridNumericColumn>
            @*X*@
            <DataGridNumericColumn TItem="Equip"
                                   Field="@nameof(Equip.X)"
                                   Caption="@(new String("X, ["+@Localizer.ohm+"]"))"
                                   Editable="true"
                                   Sortable="true"></DataGridNumericColumn>
            @*E*@
            <DataGridNumericColumn TItem="Equip"
                                   Field="@nameof(Equip.E)"
                                   Caption="@(new String(@Localizer.EMF+", ["+@Localizer.kV+"]"))"
                                   Editable="true"
                                   Sortable="true"></DataGridNumericColumn>
            @*FI_E*@
            <DataGridNumericColumn TItem="Equip"
                                   Field="@nameof(Equip.Fi_E)"
                                   Caption="@(new String(@Localizer.EMF+" "+@Localizer.angle+", ["+@Localizer.deg+"]"))"
                                   Editable="true"
                                   Sortable="true"
                                   Width="130px">

                <DisplayTemplate>
                    @{
                        double angle = ((context).Fi_E == 360 || (context).Fi_E == -360) ? (context).Fi_E = 0 : (context).Fi_E;
                        @(angle + " °")
                    }
                </DisplayTemplate>
                <EditTemplate>
                    <NumericEdit TValue="double"
                                 Value="@((double)(((CellEditContext)context).CellValue))"
                                 ValueChanged="@(v=>((CellEditContext)context).CellValue=v)"
                                 Min="-360"
                                 Max="360" />
                </EditTemplate>
            </DataGridNumericColumn>

            @*Commands*@
            <DataGridCommandColumn TItem="Equip" Width="130px">
                <NewCommandTemplate>
                    <Button Active="true"
                            Class="round"
                            Clicked="@context.Clicked">
                        <svg @onclick="@(() => {})" class="menu-icon">
                            <use href="/img/Icon.svg#Add"></use>
                        </svg>
                    </Button>
                </NewCommandTemplate>
                <EditCommandTemplate>
                    <Button Class="transparent"
                            Clicked="@context.Clicked">

                        <svg class="edit-icon" @onclick="@(() => {})">
                            <use href="/img/Icon.svg#Edit"></use>
                        </svg>
                    </Button>
                    <Button Class="transparent"
                            @onclick=@(() => DuplicateItem(context.Item))>
                        <svg class="edit-icon" @onclick="@(() => {})">
                            <use href="/img/Icon.svg#Copy"></use>
                        </svg>
                    </Button>
                </EditCommandTemplate>
                <DeleteCommandTemplate>
                    <Button Class="transparent" Clicked="@context.Clicked">
                        <svg @onclick="@(() => {})" class="edit-icon">
                            <use href="/img/Icon.svg#Delete"></use>
                        </svg>
                    </Button>
                </DeleteCommandTemplate>
                <SaveCommandTemplate>
                    <Button Class="transparent" Clicked="@context.Clicked">
                        <svg @onclick="@(() => {})" class="edit-icon">
                            <use href="/img/Icon.svg#Check"></use>
                        </svg>
                    </Button>
                </SaveCommandTemplate>
                <CancelCommandTemplate>
                    <Button Class="transparent" Clicked="@context.Clicked">
                        <svg @onclick="@(() => {})" class="edit-icon">
                            <use href="/img/Icon.svg#Delete"></use>
                        </svg>
                    </Button>
                </CancelCommandTemplate>
                <ClearFilterCommandTemplate>
                    <Button Class="transparent" Clicked="@context.Clicked">
                        <svg @onclick="@(() => {})" class="edit-icon">
                            <use href="/img/Icon.svg#Filter"></use>
                        </svg>
                    </Button>
                </ClearFilterCommandTemplate>
            </DataGridCommandColumn>
        </DataGrid>
    </div>

}

@code {
    private List<Equip> equipment { get; set; }

    void OnRowInserted(SavedRowItem<Equip, Dictionary<string, object>> e) => grid.Equipment.Add(e.Item.Id, e.Item);

    //TODO: Implement(?)
    void OnRowUpdated(SavedRowItem<Equip, Dictionary<string, object>> e) { }

    void OnRowRemoved(Equip e)
    {
        if (grid.Equipment.Values.Contains(e)) grid.Equipment.Remove(e.Id);
    }

    //TODO: Сделать механизм возникновения ошибки при одинаковых номерах (наименованиях)
    void DuplicateItem(Equip e)
    {
        var new_equip = new Equip()
        {
            Name = e.Name,
            R = e.R,
            X = e.X,
            E = e.E,
            Fi_E = e.Fi_E,
            BusId = e.BusId,
            IsActive = e.IsActive
        };

        equipment.Add(new_equip);
        grid.Equipment.Add(new_equip.Id, new_equip);

        StateHasChanged();
    }

    //Localizator
    I18nText.Pages.Branches Localizer = new I18nText.Pages.Branches();

    protected override async Task OnInitializedAsync()
    {
        Localizer = await I18nText.GetTextTableAsync<I18nText.Pages.Branches>(this);
        equipment = await Task.Run(() => grid.Equipment.Values.ToList<Equip>());
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await ValidateOnRender();
    }

}
